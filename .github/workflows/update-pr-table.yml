name: Update PR Tree

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight
  workflow_dispatch:  # Allows manual trigger

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate PR Tree
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Get all PRs created by the user
            const username = 'AhmedIbrahimSH';
            const query = `author:${username} is:pr`;
            
            const prs = await github.paginate(github.rest.search.issuesAndPullRequests, {
              q: query,
              sort: 'created',
              order: 'desc',
              per_page: 100
            });

            // Group PRs by repository
            const prsByRepo = {};
            for (const pr of prs.slice(0, 50)) {
              const repo = pr.repository_url.split('/').slice(-2).join('/');
              if (!prsByRepo[repo]) {
                prsByRepo[repo] = [];
              }
              prsByRepo[repo].push(pr);
            }

            // Generate tree structure
            let output = '## ðŸŒ³ My Open Source Contributions\n\n';
            
            const repos = Object.keys(prsByRepo);
            
            for (let i = 0; i < repos.length; i++) {
              const repo = repos[i];
              const repoPRs = prsByRepo[repo];
              const isLastRepo = i === repos.length - 1;
              const repoPrefix = isLastRepo ? 'â””â”€â”€' : 'â”œâ”€â”€';
              const childPrefix = isLastRepo ? '    ' : 'â”‚   ';
              
              // Repository branch
              output += `${repoPrefix} ðŸ“¦ **[${repo}](https://github.com/${repo})**\n`;
              
              // PRs as sub-branches (each PR is a table row at the end of branch)
              for (let j = 0; j < repoPRs.length; j++) {
                const pr = repoPRs[j];
                const isLastPR = j === repoPRs.length - 1;
                const prPrefix = isLastPR ? 'â””â”€â”€' : 'â”œâ”€â”€';
                
                const status = pr.state === 'open' ? 'ðŸŸ¢' : 
                              pr.pull_request?.merged_at ? 'ðŸŸ£' : 'ðŸ”´';
                const statusText = pr.state === 'open' ? 'Open' : 
                                  pr.pull_request?.merged_at ? 'Merged' : 'Closed';
                const created = new Date(pr.created_at).toLocaleDateString('en-US', { 
                  year: 'numeric', 
                  month: 'short', 
                  day: 'numeric' 
                });
                
                // Each PR as a table at the end of its branch
                output += `${childPrefix}${prPrefix} ${status} **[${pr.title}](${pr.html_url})**\n`;
                
                // Table for this PR's details
                const tablePrefix = isLastPR ? '    ' : 'â”‚   ';
                output += `${childPrefix}${tablePrefix}\n`;
                output += `${childPrefix}${tablePrefix}| Status | Created | Merged |\n`;
                output += `${childPrefix}${tablePrefix}|--------|---------|--------|\n`;
                
                const merged = pr.pull_request?.merged_at ? 
                              new Date(pr.pull_request.merged_at).toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric' 
                              }) : '-';
                
                output += `${childPrefix}${tablePrefix}| ${statusText} | ${created} | ${merged} |\n`;
                output += `${childPrefix}${tablePrefix}\n`;
              }
            }
            
            output += `\n*Last updated: ${new Date().toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })}*\n`;

            // Read current README
            let readme = fs.readFileSync('README.md', 'utf8');
            
            // Replace content between markers
            const startMarker = '<!-- PR_TREE_START -->';
            const endMarker = '<!-- PR_TREE_END -->';
            
            if (readme.includes(startMarker) && readme.includes(endMarker)) {
              const before = readme.substring(0, readme.indexOf(startMarker) + startMarker.length);
              const after = readme.substring(readme.indexOf(endMarker));
              readme = before + '\n' + output + '\n' + after;
            } else {
              // If markers don't exist, append to end
              readme += '\n\n' + startMarker + '\n' + output + '\n' + endMarker;
            }
            
            fs.writeFileSync('README.md', readme);

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update PR list" && git push)
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update PR tree" && git push)
